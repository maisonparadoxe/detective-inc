<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Détectives Inc.</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg:            #0a0a0a;
  --bg-raised:     #111111;
  --bg-card:       #141414;
  --bg-overlay:    rgba(10,10,10,0.92);
  --text-primary:  #e8e8e8;
  --text-secondary:#a0a0a0;
  --text-muted:    #686868;
  --border:        #2a2a2a;
  --border-active: #555555;
  --accent:        #c8b896;
  --accent-dim:    #6b5e3f;
  --danger:        #8b3a3a;
  --danger-dim:    #5a2525;
  --success:       #3a6b4a;
  --success-dim:   #2a4a35;
  --warn:          #7a6535;
  --warn-bright:   #c8a040;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
@media(min-width:601px){html,body{overflow:hidden;}}
body{background:var(--bg);color:var(--text-primary);font-family:'Inter',sans-serif;font-size:0.9rem;line-height:1.7;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#2a2a2a;}

/* ── LAYOUT ── */
#game{display:grid;grid-template-rows:auto 1fr auto;height:100vh;max-width:960px;margin:0 auto;}
@media(max-width:600px){#game{height:auto;min-height:100vh;}}
#topbar{border-bottom:1px solid var(--border);padding:12px 24px;display:flex;justify-content:space-between;align-items:center;background:var(--bg-raised);}
#main{overflow-y:auto;padding:24px;}
#bottombar{border-top:1px solid var(--border);padding:12px 24px;background:var(--bg-raised);display:flex;justify-content:space-between;align-items:center;gap:12px;}

/* ── TYPOGRAPHY ── */
.t-title{font-family:'Cormorant Garamond',serif;font-weight:300;letter-spacing:0.08em;}
.t-heading{font-family:'Cormorant Garamond',serif;font-weight:400;letter-spacing:0.04em;}
.t-label{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);}
.t-mono{font-family:'IBM Plex Mono',monospace;font-size:0.72rem;letter-spacing:0.1em;}

/* ── TOPBAR ── */
.agency-name{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:1.3rem;letter-spacing:0.1em;color:var(--accent);}
.stat-row{display:flex;gap:24px;align-items:center;}
.stat{display:flex;flex-direction:column;align-items:center;gap:2px;}
.stat-val{font-family:'IBM Plex Mono',monospace;font-size:0.85rem;color:var(--text-primary);}
.stat-val.danger{color:var(--danger);}
.stat-val.warn{color:var(--warn-bright);}
.stat-val.good{color:var(--accent);}
.day-badge{font-family:'IBM Plex Mono',monospace;font-size:0.65rem;letter-spacing:0.2em;color:var(--text-muted);border:1px solid var(--border);padding:4px 10px;}

/* ── CARDS ── */
.card{background:var(--bg-card);border:1px solid var(--border);padding:20px;animation:fadeUp 300ms ease backwards;}
.card+.card{margin-top:8px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

/* ── CRIME CARD ── */
.crime-card{border:1px solid var(--border);background:var(--bg-card);padding:16px 20px;cursor:pointer;transition:border-color 180ms ease;position:relative;animation:fadeUp 300ms ease backwards;}
.crime-card:hover{border-color:var(--border-active);}
.crime-card.selected{border-color:var(--accent-dim);background:#181510;}
.crime-card.assigned{border-color:var(--success);opacity:0.6;cursor:default;}
.crime-card.ignored{opacity:0.3;cursor:default;}
.crime-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;}
.crime-title{font-family:'Cormorant Garamond',serif;font-weight:400;font-size:1.05rem;letter-spacing:0.03em;}
.crime-reward{font-family:'IBM Plex Mono',monospace;font-size:0.68rem;color:var(--accent);letter-spacing:0.1em;}
.crime-desc{color:var(--text-secondary);font-size:0.82rem;line-height:1.65;margin-bottom:12px;}
.crime-stats{display:flex;gap:12px;}
.stat-pip{display:flex;align-items:center;gap:6px;}
.pip-label{font-family:'IBM Plex Mono',monospace;font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--text-muted);}
.pips{display:flex;gap:2px;}
.pip{width:8px;height:8px;border:1px solid var(--border);}
.pip.on.action{background:#c8b896;}
.pip.on.reflexion{background:#7a9ab5;}
.pip.on.danger{background:#8b3a3a;}
.crime-tag{position:absolute;top:12px;right:12px;font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.15em;text-transform:uppercase;padding:2px 7px;border:1px solid var(--border);color:var(--text-muted);}
.crime-tag.fantastique{border-color:var(--accent-dim);color:var(--accent-dim);}
.assigned-label{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:var(--success);margin-top:8px;}

/* ── DETECTIVE CARD ── */
.detective-card{border:1px solid var(--border);background:var(--bg-card);padding:14px 18px;cursor:pointer;transition:border-color 180ms ease;animation:fadeUp 300ms ease backwards;}
.detective-card:hover:not(.unavailable){border-color:var(--border-active);}
.detective-card.selected{border-color:var(--accent-dim);background:#181510;}
.detective-card.unavailable{opacity:0.35;cursor:not-allowed;}
.detective-card.corrupt{border-color:var(--danger-dim);}
.det-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;}
.det-name{font-family:'Cormorant Garamond',serif;font-weight:400;font-size:1rem;}
.det-age{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:var(--text-muted);}
.det-traits{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
.trait{font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.12em;text-transform:uppercase;padding:2px 7px;border:1px solid var(--border);color:var(--text-muted);}
.trait.corrupt{border-color:var(--danger-dim);color:var(--danger);}
.trait.sick{border-color:var(--warn);color:var(--warn-bright);}
.det-status{font-family:'IBM Plex Mono',monospace;font-size:0.58rem;color:var(--text-muted);margin-top:6px;}
.det-status.unavail{color:var(--danger);}
.salary-label{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;color:var(--text-muted);}

/* ── BONUS CARDS ── */
.bonus-card{border:1px solid var(--border);background:var(--bg-card);padding:14px 18px;cursor:pointer;transition:border-color 180ms ease;animation:fadeUp 300ms ease backwards;}
.bonus-card:hover:not(.used){border-color:var(--accent-dim);}
.bonus-card.selected{border-color:var(--accent);background:#181510;}
.bonus-card.used{opacity:0.3;cursor:default;}
.bonus-title{font-family:'Cormorant Garamond',serif;font-weight:400;font-size:0.95rem;margin-bottom:4px;}
.bonus-effect{font-size:0.78rem;color:var(--text-secondary);}
.bonus-neg{font-size:0.72rem;color:var(--danger);margin-top:4px;font-style:italic;}

/* ── BUTTONS ── */
.btn{font-family:'IBM Plex Mono',monospace;font-size:0.68rem;letter-spacing:0.2em;text-transform:uppercase;padding:11px 20px;background:transparent;cursor:pointer;transition:border-color 180ms ease,color 180ms ease,background 180ms ease;border:1px solid var(--border-active);color:var(--text-secondary);}
.btn:hover{border-color:var(--accent-dim);color:var(--accent);}
.btn:disabled{opacity:0.3;cursor:not-allowed;}
.btn.primary{border-color:var(--border-active);color:var(--text-secondary);}
.btn.danger{border-color:var(--danger-dim);color:var(--text-muted);}
.btn.danger:hover{border-color:var(--danger);color:var(--danger);background:rgba(139,58,58,0.06);}
.btn.small{padding:7px 14px;font-size:0.6rem;}

/* ── SECTIONS ── */
.section-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:1.6rem;letter-spacing:0.06em;margin-bottom:4px;}
.section-label{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);margin-bottom:16px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.divider{border:none;border-top:1px solid var(--border);margin:20px 0;}

/* ── PHASE HEADER ── */
.phase-header{margin-bottom:24px;}
.phase-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:2rem;letter-spacing:0.06em;margin-bottom:4px;}
.phase-sub{color:var(--text-secondary);font-size:0.85rem;}

/* ── LOG ── */
#log{max-height:120px;overflow-y:auto;display:flex;flex-direction:column;gap:4px;padding-right:4px;}
.log-entry{font-size:0.78rem;color:var(--text-secondary);padding:4px 0;border-bottom:1px solid var(--border);font-family:'IBM Plex Mono',monospace;font-size:0.62rem;letter-spacing:0.05em;}
.log-entry.success{color:var(--accent);}
.log-entry.failure{color:var(--danger);}
.log-entry.event{color:var(--warn-bright);}
.log-entry.system{color:var(--text-muted);}

/* ── OVERLAY ── */
#overlay{position:fixed;inset:0;background:var(--bg-overlay);display:none;align-items:center;justify-content:center;z-index:100;padding:24px;}
#overlay.active{display:flex;}
.modal{background:var(--bg-card);border:1px solid var(--border);padding:32px;max-width:480px;width:100%;max-height:80vh;overflow-y:auto;animation:fadeUp 300ms ease;}
.modal-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:1.8rem;letter-spacing:0.06em;margin-bottom:8px;}
.modal-label{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);margin-bottom:20px;}
.modal-body{color:var(--text-secondary);font-size:0.875rem;line-height:1.8;margin-bottom:20px;}
.modal-result{padding:16px;border:1px solid var(--border);margin-bottom:20px;}
.modal-result.success{border-color:var(--success);}
.modal-result.failure{border-color:var(--danger);}
.result-label{font-family:'IBM Plex Mono',monospace;font-size:0.58rem;letter-spacing:0.2em;text-transform:uppercase;margin-bottom:6px;}
.result-label.success{color:var(--accent);}
.result-label.failure{color:var(--danger);}
.result-text{font-size:0.875rem;color:var(--text-secondary);font-style:italic;}

/* ── HIRE MODAL ── */
.hire-option{border:1px solid var(--border);padding:14px 18px;cursor:pointer;margin-bottom:8px;transition:border-color 180ms;}
.hire-option:hover{border-color:var(--accent-dim);}
.hire-option.selected{border-color:var(--accent-dim);background:#181510;}

/* ── REP BAR ── */
.rep-bar{height:3px;background:var(--border);margin-top:4px;width:80px;}
.rep-fill{height:100%;background:var(--accent-dim);transition:width 400ms ease;}

/* ── GAME OVER ── */
#gameover{display:none;position:fixed;inset:0;background:var(--bg);z-index:200;align-items:center;justify-content:center;flex-direction:column;gap:24px;padding:40px;}
#gameover.active{display:flex;}
.go-title{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:4rem;letter-spacing:0.1em;color:var(--text-muted);}
.go-sub{font-family:'IBM Plex Mono',monospace;font-size:0.68rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--text-muted);}
.go-stats{border:1px solid var(--border);padding:24px;max-width:340px;width:100%;}

/* ── PHASE: RESULTS ── */
.result-row{display:flex;justify-content:space-between;align-items:baseline;padding:12px 0;border-bottom:1px solid var(--border);}
.result-crime{font-family:'Cormorant Garamond',serif;font-size:0.95rem;}
.result-outcome{font-family:'IBM Plex Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;}
.result-outcome.s{color:var(--accent);}
.result-outcome.f{color:var(--danger);}
.result-outcome.i{color:var(--text-muted);}
.result-money{font-family:'IBM Plex Mono',monospace;font-size:0.72rem;}
.result-money.pos{color:var(--accent);}
.result-money.neg{color:var(--danger);}

/* ── EVENT BANNER ── */
.event-banner{border:1px solid var(--warn);background:rgba(122,101,53,0.08);padding:14px 18px;margin-bottom:20px;}
.event-title{font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--warn-bright);margin-bottom:4px;}
.event-desc{font-size:0.82rem;color:var(--text-secondary);}

/* ── SCROLL ── */
#main{scrollbar-width:thin;scrollbar-color:#2a2a2a transparent;}

/* ── RESPONSIVE ── */
/* ── RESPONSIVE ── */

/* Tablette (< 768px) */
@media(max-width:768px){
  #game{max-width:100%;}
  .grid-2{grid-template-columns:1fr 1fr;}
  .grid-3{grid-template-columns:1fr 1fr;}
  #topbar{padding:10px 16px;}
  #main{padding:16px;}
  #bottombar{padding:10px 16px;}
}

/* Mobile (< 600px) — refonte complète */
@media(max-width:600px){
  /* Scroll natif — pas de layout fixe */
  html,body{height:auto;overflow:auto;}
  #game{
    display:flex;
    flex-direction:column;
    height:auto;
    min-height:100vh;
  }
  #main{
    overflow:visible;
    padding:14px;
    flex:1;
  }

  /* Topbar — nom + stats empilés */
  #topbar{
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
    padding:12px 14px;
  }
  .agency-name{font-size:1.1rem;}
  .stat-row{
    width:100%;
    display:grid;
    grid-template-columns:1fr 1fr 1fr auto;
    gap:0;
    border:1px solid var(--border);
  }
  .stat{
    padding:8px 10px;
    border-right:1px solid var(--border);
    align-items:flex-start;
  }
  .stat:last-child{border-right:none;}
  .stat-val{font-size:0.8rem;}
  .day-badge{
    padding:8px 10px;
    border:none;
    align-self:center;
    font-size:0.58rem;
  }
  .rep-bar{width:48px;}

  /* Bottombar — log caché, boutons pleine largeur */
  #bottombar{
    flex-direction:column-reverse;
    align-items:stretch;
    gap:8px;
    padding:12px 14px;
    position:sticky;
    bottom:0;
    z-index:10;
    background:var(--bg-raised);
  }
  #log{
    max-height:60px;
    font-size:0.6rem;
    border-top:1px solid var(--border);
    padding-top:8px;
    flex:unset;
  }
  #bottombar > div:last-child{
    display:grid;
    grid-template-columns:1fr 1fr 2fr;
    gap:6px;
    width:100%;
  }
  #bottombar .btn{
    width:100%;
    max-width:none;
    padding:12px 8px;
    font-size:0.58rem;
    letter-spacing:0.12em;
    text-align:center;
  }

  /* Grilles */
  .grid-2,.grid-3{grid-template-columns:1fr;}

  /* Cards — padding réduit */
  .card{padding:14px;}
  .crime-card,.detective-card,.bonus-card,.hire-option{padding:12px 14px;}

  /* Phase header */
  .phase-title{font-size:1.5rem;}
  .phase-sub{font-size:0.8rem;}

  /* Crime stats — plus compact */
  .crime-stats{flex-wrap:wrap;gap:8px;}
  .pip{width:7px;height:7px;}

  /* Modal */
  #overlay{padding:12px;}
  .modal{padding:20px;max-height:90vh;}
  .modal-title{font-size:1.4rem;}

  /* Section label */
  .section-label{font-size:0.55rem;}

  /* Buttons */
  .btn{font-size:0.62rem;padding:10px 16px;}
  .btn.small{padding:9px 12px;font-size:0.58rem;}

  /* Result rows */
  .result-row{flex-wrap:wrap;gap:4px;}
  .result-crime{font-size:0.85rem;}
  .result-outcome,.result-money{font-size:0.58rem;}

  /* Det card traits */
  .det-traits{gap:4px;}
  .trait{font-size:0.5rem;padding:2px 5px;}

  /* Event banner */
  .event-banner{padding:12px 14px;}
  .event-title{font-size:0.95rem;}
}

/* Très petits écrans (< 380px) */
@media(max-width:380px){
  .agency-name{font-size:1rem;}
  .stat-val{font-size:0.72rem;}
  #bottombar > div:last-child{
    grid-template-columns:1fr 1fr;
    grid-template-rows:auto auto;
  }
  #btn-action{
    grid-column:1/-1;
  }
  .phase-title{font-size:1.3rem;}
  .crime-title{font-size:0.95rem;}
  .det-name{font-size:0.9rem;}
}
</style>
</head>
<body>

<div id="game">
  <div id="topbar">
    <div style="display:flex;flex-direction:column;gap:3px;">
      <span class="agency-name">Détectives Inc.</span>
      <a href="https://maisonparadoxe.github.io/" target="_blank" rel="noopener"
         style="font-family:'IBM Plex Mono',monospace;font-size:0.55rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--text-muted);text-decoration:none;border-bottom:1px solid var(--border);padding-bottom:1px;transition:color 200ms ease,border-color 200ms ease;"
         onmouseover="this.style.color='var(--accent)';this.style.borderColor='var(--accent-dim)'"
         onmouseout="this.style.color='var(--text-muted)';this.style.borderColor='var(--border)'">
        Maison Paradoxe ↗
      </a>
    </div>
    <div class="stat-row">
      <div class="stat">
        <span class="t-label">Argent</span>
        <span class="stat-val good" id="ui-money">—</span>
      </div>
      <div class="stat">
        <span class="t-label">Réputation</span>
        <div>
          <span class="stat-val" id="ui-rep">—</span>
          <div class="rep-bar"><div class="rep-fill" id="ui-rep-bar" style="width:50%"></div></div>
        </div>
      </div>
      <div class="stat">
        <span class="t-label">Enquêteurs</span>
        <span class="stat-val" id="ui-dets">—</span>
      </div>
      <span class="day-badge" id="ui-day">Jour —</span>
    </div>
  </div>

  <div id="main"></div>

  <div id="bottombar">
    <div id="log" style="flex:1;"></div>
    <div style="display:flex;gap:8px;flex-shrink:0;">
      <button class="btn small" onclick="openRulesModal()">? Règles</button>
      <button class="btn small" id="btn-hire" onclick="openHireModal()">+ Recruter</button>
      <button class="btn primary" id="btn-action" onclick="handleAction()">—</button>
    </div>
  </div>
</div>

<!-- OVERLAY -->
<div id="overlay">
  <div class="modal" id="modal-content"></div>
</div>

<!-- GAME OVER -->
<div id="gameover" id="gameover">
  <div class="go-title">Dossier Fermé</div>
  <div class="go-sub" id="go-reason">L'agence a fermé ses portes.</div>
  <div class="go-stats card" id="go-stats"></div>
  <button class="btn primary" onclick="initGame()">Nouvelle Agence</button>
</div>

<script>
/* ══════════════════════════════════════════════
   DONNÉES
══════════════════════════════════════════════ */
const ALL_CRIMES = [
  { id:1, titre:"Vol du Diamant Bleu", type:"action", desc:"Un diamant d'exception a disparu d'un hôtel du IIIe arrondissement. Le directeur veut discrétion absolue.", action:4, reflexion:1, danger:2, recompense:300, temps:1, tag:"Réaliste", histoire:"La chambre forte était déverrouillée de l'intérieur. Le personnel de nuit se contredit.", fins:{succes:"Le diamant est retrouvé dans la doublure du manteau du groom. L'affaire est réglée sans bruit.",echec:"Le diamant disparaît dans les bas-fonds. Votre réputation en prend un coup."}},
  { id:2, titre:"Meurtre à l'Opéra", type:"reflexion", desc:"Le baryton principal a été retrouvé mort dans sa loge. Plusieurs suspects, aucun mobile apparent.", action:1, reflexion:5, danger:2, recompense:500, temps:1, tag:"Réaliste", histoire:"Une lettre anonyme avait averti la victime trois jours avant. Personne ne l'avait prise au sérieux.", fins:{succes:"La femme du baryton est confondue. La presse salue votre perspicacité.",echec:"Le meurtrier s'échappe. La ville bruisse de vos échecs."}},
  { id:3, titre:"Chantage Politique", type:"danger", desc:"Un sénateur reçoit des menaces. Il refuse de contacter la police. Affaire ultra-sensible.", action:2, reflexion:3, danger:4, recompense:450, temps:1, tag:"Réaliste", histoire:"Les lettres de chantage contiennent des informations que seul l'entourage immédiat pouvait connaître.", fins:{succes:"Le maître chanteur est neutralisé. Le sénateur vous envoie une enveloppe non tracée.",echec:"Le scandale éclate. Le sénateur vous accuse publiquement de négligence."}},
  { id:4, titre:"Disparition du Journaliste", type:"reflexion", desc:"Un reporter enquêtant sur des trafics portuaires a disparu. Sa rédaction préfère la discrétion.", action:2, reflexion:4, danger:3, recompense:400, temps:1, tag:"Réaliste", histoire:"Son dernier article mentionnait une connexion entre le port et une famille noble. Ses notes ont été volées.", fins:{succes:"Le journaliste est retrouvé vivant dans un entrepôt du 12e. L'histoire fait la une.",echec:"Aucune trace. La rédaction coupe tout contact avec votre agence."}},
  { id:5, titre:"L'Héritière Fantôme", type:"action", desc:"Une jeune héritière prétend voir sa défunte mère dans les couloirs de son manoir. La famille veut des réponses.", action:3, reflexion:2, danger:1, recompense:250, temps:1, tag:"Réaliste", histoire:"Des objets bougent la nuit. La cuisinière a démissionné sans explication.", fins:{succes:"Il s'agissait d'un cousin cupide qui simulait les apparitions pour terroriser l'héritière.",echec:"L'héritière quitte le manoir. Le mystère demeure entier."}},
  { id:6, titre:"Le Pacte du Peintre Maudit", type:"danger", desc:"Un peintre célèbre prétend avoir signé un contrat avec une entité. Ses toiles montrent des scènes non encore advenues.", action:1, reflexion:3, danger:5, recompense:600, temps:1, tag:"Fantastique", histoire:"Trois scènes peintes se sont réalisées à l'identique. La quatrième toile représente votre agence en flammes.", fins:{succes:"La manipulation est déjouée. Le peintre était instrumentalisé par un réseau occulte.",echec:"La quatrième toile se réalise. Vous perdez du matériel et un enquêteur est hospitalisé."}},
  { id:7, titre:"La Malédiction de la Montre", type:"reflexion", desc:"Trois propriétaires successifs de la même montre de gousset sont morts dans des circonstances identiques.", action:1, reflexion:5, danger:3, recompense:550, temps:1, tag:"Fantastique", histoire:"La montre indique toujours 3h17, quelle que soit l'heure. Le dernier propriétaire est mort à 3h17.", fins:{succes:"La montre dissimulait un mécanisme libérant un poison de contact. Affaire résolue.",echec:"La malédiction continue. Votre enquêteur présente des symptômes inexpliqués."}},
  { id:8, titre:"Le Cabaret des Ombres", type:"action", desc:"Des clients du cabaret Théodore signalent des heures perdues. Aucun souvenir entre minuit et l'aube.", action:4, reflexion:2, danger:3, recompense:380, temps:1, tag:"Fantastique", histoire:"Les employés du cabaret ne présentent aucune anomalie. Seuls les clients sont affectés.", fins:{succes:"Une substance hallucinogène était diffusée via la ventilation. Le gérant arrêté.",echec:"L'enquêteur perd lui aussi plusieurs heures. L'affaire reste ouverte."}},
  { id:9, titre:"Vol dans les Archives", type:"reflexion", desc:"Des dossiers sensibles ont disparu de la préfecture. Pas d'effraction visible.", action:1, reflexion:4, danger:2, recompense:350, temps:1, tag:"Réaliste", histoire:"Les archives concernaient des affaires classées liées à une famille d'industriels.", fins:{succes:"Un fonctionnaire corrompu est confondu. La préfecture vous recommande discrètement.",echec:"Les dossiers ne réapparaissent pas. L'affaire est étouffée."}},
  { id:10, titre:"L'Enfant des Catacombes", type:"danger", desc:"Un enfant prétend venir des catacombes et ne parle qu'en ancien français. Il connaît des détails sur des meurtres non élucidés.", action:2, reflexion:4, danger:4, recompense:500, temps:1, tag:"Fantastique", histoire:"L'enfant cite des noms qui n'apparaissent que dans des archives scellées. Il a disparu de l'hôpital sans laisser de trace.", fins:{succes:"Une organisation d'escrocs se servait de l'enfant comme leurre. Réseau démantelé.",echec:"L'enfant disparaît. Les meurtres évoqués reprennent."}},
];

const ALL_DETECTIVES = [
  { id:1, nom:"Éloi Vesper", age:35, action:2, reflexion:5, danger:1, salaire:100, corrompu:false, malade:false, traits:["Perspicace","Fragile"], bio:"Ancien archiviste reconverti. Lit les scènes de crime comme des textes anciens." },
  { id:2, nom:"Céleste Noir", age:29, action:4, reflexion:3, danger:2, salaire:110, corrompu:true, malade:false, traits:["Redoutable","Corrompue"], bio:"Ancienne policière renvoyée. Efficace, mais ses loyautés sont en vente." },
  { id:3, nom:"Auguste Flamel", age:52, action:3, reflexion:3, danger:3, salaire:130, corrompu:false, malade:false, traits:["Équilibré","Expérimenté"], bio:"Trente ans de terrain. Rien ne le surprend vraiment." },
  { id:4, nom:"Margot Sérane", age:26, action:5, reflexion:2, danger:2, salaire:90, corrompu:false, malade:false, traits:["Impétueuse","Rapide"], bio:"Ancienne championne d'athlétisme. S'ennuie vite, agit d'abord." },
  { id:5, nom:"Théodore Vane", age:44, action:1, reflexion:4, danger:4, salaire:120, corrompu:false, malade:false, traits:["Téméraire","Intuitif"], bio:"Passé trouble dans les milieux souterrains. Connaît tout le monde, rien ne l'effraie." },
  { id:6, nom:"Irma Duval", age:38, action:3, reflexion:4, danger:2, salaire:115, corrompu:false, malade:false, traits:["Méthodique","Discrète"], bio:"Ancienne journaliste d'investigation. Pose les bonnes questions." },
  { id:7, nom:"Lucien Faux", age:31, action:4, reflexion:2, danger:3, salaire:95, corrompu:true, malade:false, traits:["Efficace","Corrompu"], bio:"Les résultats sont là. Mais il garde toujours quelque chose pour lui." },
  { id:8, nom:"Octave Brun", age:61, action:1, reflexion:5, danger:1, salaire:105, corrompu:false, malade:true, traits:["Brillant","Fragile","Malade"], bio:"Le meilleur analyste de la ville. Sa santé ne tient qu'à un fil." },
];

const ALL_BONUS = [
  { id:1, titre:"Dossier Complet", effet:"+25% de chance de succès", bonus:25, negatif:null },
  { id:2, titre:"Contact Police", effet:"Réduit le danger de 1 point", bonus:0, dangerMod:-1, negatif:null },
  { id:3, titre:"Témoin Inattendu", effet:"Effet aléatoire — peut aider ou nuire", bonus:0, aleatoire:true, negatif:"Peut réduire les chances de succès de 15%" },
  { id:4, titre:"Indic de Confiance", effet:"+20% succès sur crimes de réflexion", bonus:20, type:"reflexion", negatif:null },
  { id:5, titre:"Couverture Officielle", effet:"Annule les pertes de réputation en cas d'échec", bonus:0, protectRep:true, negatif:null },
  { id:6, titre:"Pression Médiatique", effet:"+30% succès, mais double la perte de réputation si échec", bonus:30, repMalus:2, negatif:"Double la perte de réputation en cas d'échec" },
  { id:7, titre:"Archive Occulte", effet:"+35% sur crimes fantastiques", bonus:35, type:"fantastique", negatif:null },
  { id:8, titre:"Filet de Sécurité", effet:"L'enquêteur ne peut pas être blessé", bonus:0, protectDet:true, negatif:null },
];

const EVENTS = [
  { id:1, titre:"Grève des policiers", desc:"Les forces de l'ordre sont inopérantes. Les crimes de type Danger sont plus risqués aujourd'hui.", effet:"danger+1" },
  { id:2, titre:"Presse favorable", desc:"Un article vous présente sous un jour flatteur. Bonus de réputation.", effet:"rep+5" },
  { id:3, titre:"Pluie torrentielle", desc:"Les déplacements sont difficiles. Taux de succès réduit de 10% pour tous.", effet:"global-10" },
  { id:4, titre:"Client mystérieux", desc:"Un inconnu laisse une enveloppe contenant 200€ et aucune explication.", effet:"money+200" },
  { id:5, titre:"Inspection des Mœurs", desc:"Des agents scrutent vos activités. Un enquêteur corrompu est suspendu ce jour.", effet:"suspend-corrupt" },
  { id:6, titre:"Nuit de brouillard", desc:"La ville est paralysée. Un crime supplémentaire aléatoire s'ajoute au plateau.", effet:"extra-crime" },
  { id:7, titre:"Rumeurs de couloirs", desc:"On parle de votre agence en mauvais termes. -5 réputation.", effet:"rep-5" },
  { id:8, titre:"Calme plat", desc:"Rien de particulier aujourd'hui. Journée normale.", effet:"none" },
];

const HIRE_CANDIDATES = [
  { id:10, nom:"Bastien Crue", age:24, action:3, reflexion:2, danger:3, salaire:80, corrompu:false, malade:false, traits:["Novice","Courageux"], bio:"Tout juste sorti de l'académie. Motivé, inexpérimenté.", cout:150 },
  { id:11, nom:"Simone Ader", age:41, action:2, reflexion:5, danger:2, salaire:125, corrompu:false, malade:false, traits:["Experte","Chère"], bio:"Spécialiste des affaires complexes. Prix en conséquence.", cout:300 },
  { id:12, nom:"Jules Marchand", age:34, action:4, reflexion:3, danger:1, salaire:100, corrompu:false, malade:false, traits:["Action","Équilibré"], bio:"Ancien boxeur reconverti. Préfère les résultats directs.", cout:200 },
  { id:13, nom:"Nora Stein", age:38, action:2, reflexion:4, danger:4, salaire:115, corrompu:false, malade:false, traits:["Téméraire","Analytique"], bio:"Passée par plusieurs agences. Sait gérer le risque.", cout:250 },
];

/* ══════════════════════════════════════════════
   ÉTAT
══════════════════════════════════════════════ */
let G = {};

function initGame() {
  document.getElementById('gameover').classList.remove('active');
  G = {
    day: 1,
    money: 800,
    reputation: 50,
    detectives: [
      {...ALL_DETECTIVES[0], indisponible:0},
      {...ALL_DETECTIVES[2], indisponible:0},
      {...ALL_DETECTIVES[3], indisponible:0},
    ],
    crimes: [],
    bonusCards: [],
    assignments: {},   // crimeId -> { detId, bonusId }
    phase: 'morning',  // morning | assign | resolve | evening
    event: null,
    results: [],
    totalDays: 0,
    totalResolved: 0,
    globalModifier: 0,
    dangerModifier: 0,
    selectedCrime: null,
    selectedDet: null,
    selectedBonus: null,
  };
  startMorning();
}

/* ══════════════════════════════════════════════
   PHASES
══════════════════════════════════════════════ */
function startMorning() {
  G.phase = 'morning';
  G.selectedCrime = null;
  G.selectedDet = null;
  G.selectedBonus = null;
  G.assignments = {};
  G.globalModifier = 0;
  G.dangerModifier = 0;
  G.results = [];

  // Pick event
  G.event = EVENTS[Math.floor(Math.random() * EVENTS.length)];
  applyEventStart(G.event);

  // Pick 3 crimes
  const pool = [...ALL_CRIMES].sort(() => Math.random()-0.5);
  G.crimes = pool.slice(0,3);
  if (G.event.effet === 'extra-crime') {
    G.crimes.push(pool[3]);
  }

  // Pick 2 bonus cards
  const bpool = [...ALL_BONUS].sort(() => Math.random()-0.5);
  G.bonusCards = bpool.slice(0,2).map(b => ({...b, used:false}));

  // Age detectives every 5 days
  if (G.day % 5 === 0) {
    G.detectives.forEach(d => {
      d.age++;
      if (d.age > 55) d.action = Math.max(1, d.action-1);
      if (d.age > 50) d.reflexion = Math.min(5, d.reflexion+1);
    });
  }

  // Check available detectives
  G.detectives.forEach(d => {
    if (d.indisponible > 0) d.indisponible--;
  });

  updateUI();
  renderMorning();
}

function applyEventStart(ev) {
  switch(ev.effet) {
    case 'rep+5': G.reputation = Math.min(100, G.reputation+5); addLog(`${ev.titre} — +5 réputation.`, 'event'); break;
    case 'rep-5': G.reputation = Math.max(0, G.reputation-5); addLog(`${ev.titre} — -5 réputation.`, 'event'); break;
    case 'money+200': G.money += 200; addLog(`${ev.titre} — +200€ trouvés.`, 'event'); break;
    case 'global-10': G.globalModifier = -10; addLog(`${ev.titre} — -10% succès aujourd'hui.`, 'event'); break;
    case 'danger+1': G.dangerModifier = 1; addLog(`${ev.titre} — Danger accru.`, 'event'); break;
    case 'suspend-corrupt':
      G.detectives.forEach(d => { if(d.corrompu && d.indisponible===0) { d.indisponible=1; addLog(`${d.nom} suspendu(e) par l'Inspection.`,'event'); } });
      break;
    default: addLog(`${ev.titre}.`, 'event');
  }
}

function startAssign() {
  G.phase = 'assign';
  updateUI();
  renderAssign();
}

function resolveAll() {
  G.phase = 'resolve';
  G.results = [];

  // Resolve assigned crimes
  G.crimes.forEach(crime => {
    const asgn = G.assignments[crime.id];
    if (!asgn) {
      G.results.push({ crime, outcome:'ignored', money:0, repDelta:-3, story:null });
      G.reputation = Math.max(0, G.reputation - 3);
      return;
    }
    const det = G.detectives.find(d => d.id === asgn.detId);
    const bonus = asgn.bonusId ? G.bonusCards.find(b => b.id === asgn.bonusId) : null;

    // Compute success chance
    let chance = computeChance(crime, det, bonus);
    const roll = Math.random() * 100;
    const success = roll < chance;

    let money = 0;
    let repDelta = 0;

    if (success) {
      money = crime.recompense;
      // Corrupt detective skims
      if (det.corrompu) {
        const skim = Math.floor(money * 0.2);
        money -= skim;
        addLog(`${det.nom} a prélevé ${skim}€ au passage.`, 'failure');
      }
      repDelta = 5;
      G.money += money;
      G.reputation = Math.min(100, G.reputation + repDelta);
      G.totalResolved++;
      addLog(`${crime.titre} — Résolu par ${det.nom}. +${money}€`, 'success');
    } else {
      money = -50;
      repDelta = bonus && bonus.protectRep ? 0 : -8;
      if (G.reputation < 30) repDelta = -4; // bad rep attire moins d'attention
      G.money = Math.max(0, G.money + money);
      G.reputation = Math.max(0, G.reputation + repDelta);
      // Random: detective hurt on high danger
      if (crime.danger >= 4 && Math.random() < 0.3 && !(bonus && bonus.protectDet)) {
        det.indisponible = 2;
        addLog(`${det.nom} blessé(e) — indisponible 2 jours.`, 'failure');
      }
      addLog(`${crime.titre} — Échec. ${money}€ de pénalité.`, 'failure');
    }

    G.results.push({ crime, det, bonus, outcome: success?'success':'failure', money, repDelta, story: success ? crime.fins.succes : crime.fins.echec });
  });

  G.totalDays++;
  updateUI();
  renderResults();
}

function computeChance(crime, det, bonus) {
  // Base: weighted competence vs difficulty
  const mainStat = crime.type === 'action' ? det.action : crime.type === 'reflexion' ? det.reflexion : det.danger;
  const difficulty = crime.type === 'action' ? crime.action : crime.type === 'reflexion' ? crime.reflexion : crime.danger;
  let chance = 30 + (mainStat / difficulty) * 50;

  // Bonus
  if (bonus) {
    if (bonus.aleatoire) { chance += (Math.random() > 0.5 ? 20 : -15); }
    else if (bonus.type && bonus.type === crime.tag.toLowerCase()) { chance += bonus.bonus; }
    else if (!bonus.type) { chance += bonus.bonus || 0; }
    if (bonus.dangerMod) { chance += bonus.dangerMod * 8; }
  }

  // Global modifier
  chance += G.globalModifier;

  // Danger modifier from event
  if (crime.type === 'danger') chance -= G.dangerModifier * 10;

  // Reputation influence
  if (G.reputation > 70) chance += 5;
  if (G.reputation < 30) chance -= 5;

  return Math.min(95, Math.max(10, chance));
}

function startEvening() {
  G.phase = 'evening';

  // Pay salaries
  let totalSalary = 0;
  G.detectives.forEach(d => { totalSalary += d.salaire; });
  const rent = 100;
  const expenses = totalSalary + rent;
  G.money = Math.max(0, G.money - expenses);
  addLog(`Frais du jour — salaires ${totalSalary}€ + loyer ${rent}€ = -${expenses}€.`, 'system');

  // Sick detective random
  G.detectives.forEach(d => {
    if (!d.malade && Math.random() < 0.05) {
      d.malade = true;
      d.action = Math.max(1, d.action - 1);
      addLog(`${d.nom} tombe malade. -1 Action.`, 'failure');
    }
  });

  // Check game over
  if (G.money <= 0 && G.detectives.filter(d=>d.indisponible===0).length === 0) {
    gameOver("L'agence n'a plus de fonds ni de détectives disponibles.");
    return;
  }
  if (G.reputation <= 0) {
    gameOver("Votre réputation est anéantie. Plus personne ne vous fait confiance.");
    return;
  }

  G.day++;
  updateUI();
  renderEvening(totalSalary, rent);
}

/* ══════════════════════════════════════════════
   RENDER
══════════════════════════════════════════════ */
function renderMorning() {
  const main = document.getElementById('main');
  let html = `<div class="phase-header"><div class="phase-title t-title">Jour ${G.day} — Aube</div><div class="phase-sub">Nouvelles affaires reçues. Préparez vos enquêteurs.</div></div>`;

  // Event
  if (G.event && G.event.effet !== 'none') {
    html += `<div class="event-banner"><div class="event-title">${G.event.titre}</div><div class="event-desc">${G.event.desc}</div></div>`;
  }

  // Crimes
  html += `<div class="section-label">Affaires du jour</div>`;
  html += `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px;">`;
  G.crimes.forEach(c => {
    html += renderCrimeCard(c, false);
  });
  html += `</div>`;

  // Bonus cards
  html += `<div class="section-label">Cartes bonus disponibles</div>`;
  html += `<div class="grid-2" style="margin-bottom:24px;">`;
  G.bonusCards.forEach(b => {
    html += `<div class="bonus-card"><div class="bonus-title t-heading">${b.titre}</div><div class="bonus-effect">${b.effet}</div>${b.negatif?`<div class="bonus-neg">${b.negatif}</div>`:''}</div>`;
  });
  html += `</div>`;

  main.innerHTML = html;
  document.getElementById('btn-action').textContent = 'Assigner les enquêteurs →';
  document.getElementById('btn-action').onclick = startAssign;
}

function renderAssign() {
  const main = document.getElementById('main');
  let html = `<div class="phase-header"><div class="phase-title t-title">Assignation</div><div class="phase-sub">Sélectionnez un crime, puis un enquêteur, puis une carte bonus optionnelle.</div></div>`;

  // Crimes
  html += `<div class="section-label">Affaires — cliquez pour sélectionner</div>`;
  html += `<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px;">`;
  G.crimes.forEach(c => {
    const asgn = G.assignments[c.id];
    const det = asgn ? G.detectives.find(d=>d.id===asgn.detId) : null;
    let cls = '';
    if (G.selectedCrime && G.selectedCrime.id === c.id) cls = 'selected';
    else if (asgn) cls = 'assigned';
    html += renderCrimeCard(c, true, cls, det);
  });
  html += `</div>`;

  // Detectives
  html += `<div class="section-label">Enquêteurs disponibles</div>`;
  html += `<div class="grid-2" style="margin-bottom:20px;">`;
  const availDetIds = new Set(Object.values(G.assignments).map(a=>a.detId));
  G.detectives.forEach((d,i) => {
    const unavail = d.indisponible > 0 || availDetIds.has(d.id);
    let cls = unavail ? 'unavailable' : '';
    if (G.selectedDet && G.selectedDet.id === d.id) cls = 'selected';
    if (d.corrompu) cls += ' corrupt';
    html += `<div class="detective-card ${cls}" style="animation-delay:${i*50}ms" onclick="selectDet(${d.id})">
      <div class="det-header"><span class="det-name t-heading">${d.nom}</span><span class="det-age">${d.age} ans</span></div>
      ${renderStatPips(d)}
      <div class="det-traits">${d.traits.map(t=>`<span class="trait ${t==='Corrompue'||t==='Corrompu'?'corrupt':t==='Malade'||t==='Fragile'?'sick':''}">${t}</span>`).join('')}</div>
      <div class="salary-label t-label" style="margin-top:8px;">${d.salaire}€/jour</div>
      ${unavail && d.indisponible>0?`<div class="det-status unavail">Indisponible — ${d.indisponible}j</div>`:''}
    </div>`;
  });
  html += `</div>`;

  // Bonus
  html += `<div class="section-label">Carte bonus — optionnel</div>`;
  html += `<div class="grid-2" style="margin-bottom:20px;">`;
  G.bonusCards.forEach(b => {
    const usedInAsgn = Object.values(G.assignments).find(a=>a.bonusId===b.id);
    let cls = b.used || usedInAsgn ? 'used' : '';
    if (G.selectedBonus && G.selectedBonus.id === b.id) cls = 'selected';
    html += `<div class="bonus-card ${cls}" onclick="selectBonus(${b.id})"><div class="bonus-title t-heading">${b.titre}</div><div class="bonus-effect">${b.effet}</div>${b.negatif?`<div class="bonus-neg">${b.negatif}</div>`:''}</div>`;
  });
  html += `</div>`;

  // Assign button
  if (G.selectedCrime && G.selectedDet) {
    html += `<div style="margin-bottom:12px;"><button class="btn primary" onclick="assignSelected()">Assigner ${G.selectedDet.nom} → ${G.selectedCrime.titre}</button></div>`;
  }

  main.innerHTML = html;

  const canResolve = Object.keys(G.assignments).length > 0;
  document.getElementById('btn-action').textContent = canResolve ? 'Lancer les enquêtes →' : 'Passer (ignorer tout)';
  document.getElementById('btn-action').onclick = resolveAll;
}

function renderCrimeCard(c, clickable, extraCls='', assignedDet=null) {
  const onclick = clickable && !assignedDet ? `onclick="selectCrime(${c.id})"` : '';
  const isFantastique = c.tag === 'Fantastique';
  return `<div class="crime-card ${extraCls}" ${onclick} style="animation-delay:${c.id*40}ms">
    <span class="crime-tag ${isFantastique?'fantastique':''}">${c.tag}</span>
    <div class="crime-header">
      <span class="crime-title t-heading">${c.titre}</span>
      <span class="crime-reward">${c.recompense}€</span>
    </div>
    <div class="crime-desc">${c.desc}</div>
    <div class="crime-stats">
      <div class="stat-pip"><span class="pip-label">Action</span><div class="pips">${renderPips(c.action,'action')}</div></div>
      <div class="stat-pip"><span class="pip-label">Réflexion</span><div class="pips">${renderPips(c.reflexion,'reflexion')}</div></div>
      <div class="stat-pip"><span class="pip-label">Danger</span><div class="pips">${renderPips(c.danger,'danger')}</div></div>
    </div>
    ${assignedDet?`<div class="assigned-label">↳ ${assignedDet.nom}</div>`:''}
  </div>`;
}

function renderPips(val, type) {
  let html='';
  for(let i=1;i<=5;i++) html+=`<div class="pip ${i<=val?'on':''} ${type}"></div>`;
  return html;
}

function renderStatPips(d) {
  return `<div class="crime-stats" style="margin-top:6px;">
    <div class="stat-pip"><span class="pip-label">Act</span><div class="pips">${renderPips(d.action,'action')}</div></div>
    <div class="stat-pip"><span class="pip-label">Réf</span><div class="pips">${renderPips(d.reflexion,'reflexion')}</div></div>
    <div class="stat-pip"><span class="pip-label">Dng</span><div class="pips">${renderPips(d.danger,'danger')}</div></div>
  </div>`;
}

function renderResults() {
  const main = document.getElementById('main');
  let html = `<div class="phase-header"><div class="phase-title t-title">Résultats</div><div class="phase-sub">Bilan de la journée d'enquête.</div></div>`;

  html += `<div style="display:flex;flex-direction:column;gap:1px;margin-bottom:24px;">`;
  G.results.forEach(r => {
    const cls = r.outcome==='success'?'s':r.outcome==='ignored'?'i':'f';
    const moneyStr = r.money >= 0 ? `+${r.money}€` : `${r.money}€`;
    const moneyCls = r.money >= 0 ? 'pos' : 'neg';
    html += `<div class="result-row">
      <span class="result-crime t-heading">${r.crime.titre}</span>
      <span class="result-outcome ${cls}">${r.outcome==='success'?'Résolu':r.outcome==='ignored'?'Ignoré':'Échec'}</span>
      <span class="result-money ${moneyCls}">${moneyStr}</span>
    </div>`;
  });
  html += `</div>`;

  // Stories
  html += `<div class="section-label">Récits</div>`;
  G.results.filter(r=>r.story).forEach(r => {
    html += `<div class="modal-result ${r.outcome}" style="margin-bottom:8px;">
      <div class="result-label ${r.outcome}">${r.crime.titre} — ${r.outcome==='success'?'Résolu':'Échec'}</div>
      <div class="result-text">${r.story}</div>
    </div>`;
  });

  main.innerHTML = html;
  document.getElementById('btn-action').textContent = 'Fin de journée →';
  document.getElementById('btn-action').onclick = startEvening;
}

function renderEvening(salaries, rent) {
  const main = document.getElementById('main');
  let html = `<div class="phase-header"><div class="phase-title t-title">Fin de Journée</div><div class="phase-sub">Bilan financier et état de l'agence.</div></div>`;

  html += `<div class="card" style="margin-bottom:12px;">
    <div class="section-label">Finances</div>
    <div class="result-row"><span>Salaires versés</span><span class="result-money neg">-${salaries}€</span></div>
    <div class="result-row"><span>Loyer</span><span class="result-money neg">-${rent}€</span></div>
    <div class="result-row"><span>Solde restant</span><span class="result-money ${G.money>200?'pos':G.money>0?'':''}">${G.money}€</span></div>
  </div>`;

  html += `<div class="card" style="margin-bottom:12px;">
    <div class="section-label">État des enquêteurs</div>`;
  G.detectives.forEach(d => {
    html += `<div class="result-row">
      <span class="t-heading" style="font-size:0.95rem;">${d.nom}</span>
      <span class="t-mono" style="color:var(--text-muted);">${d.age} ans</span>
      <span class="t-label">${d.indisponible>0?`Indisponible ${d.indisponible}j`:d.malade?'Malade':'Disponible'}</span>
    </div>`;
  });
  html += `</div>`;

  main.innerHTML = html;
  document.getElementById('btn-action').textContent = `Jour ${G.day} →`;
  document.getElementById('btn-action').onclick = startMorning;
}

/* ══════════════════════════════════════════════
   INTERACTIONS
══════════════════════════════════════════════ */
function selectCrime(id) {
  if (G.phase !== 'assign') return;
  const crime = G.crimes.find(c=>c.id===id);
  if (G.assignments[id]) return;
  G.selectedCrime = (G.selectedCrime && G.selectedCrime.id===id) ? null : crime;
  tryAutoAssign();
  renderAssign();
}

function selectDet(id) {
  if (G.phase !== 'assign') return;
  const det = G.detectives.find(d=>d.id===id);
  if (det.indisponible > 0) return;
  const usedDetIds = new Set(Object.values(G.assignments).map(a=>a.detId));
  if (usedDetIds.has(id)) return;
  G.selectedDet = (G.selectedDet && G.selectedDet.id===id) ? null : det;
  tryAutoAssign();
  renderAssign();
}

function selectBonus(id) {
  if (G.phase !== 'assign') return;
  const bonus = G.bonusCards.find(b=>b.id===id);
  const usedInAsgn = Object.values(G.assignments).find(a=>a.bonusId===id);
  if (usedInAsgn) return;
  G.selectedBonus = (G.selectedBonus && G.selectedBonus.id===id) ? null : bonus;
  renderAssign();
}

function tryAutoAssign() {
  if (G.selectedCrime && G.selectedDet) {
    // highlight only, don't auto-assign
  }
}

function assignSelected() {
  if (!G.selectedCrime || !G.selectedDet) return;
  G.assignments[G.selectedCrime.id] = {
    detId: G.selectedDet.id,
    bonusId: G.selectedBonus ? G.selectedBonus.id : null,
  };
  addLog(`${G.selectedDet.nom} assigné(e) à "${G.selectedCrime.titre}".`, 'system');
  G.selectedCrime = null;
  G.selectedDet = null;
  G.selectedBonus = null;
  renderAssign();
}

/* ══════════════════════════════════════════════
   HIRE
══════════════════════════════════════════════ */
function openHireModal() {
  const content = document.getElementById('modal-content');
  let html = `<div class="modal-title t-title">Recruter</div><div class="modal-label">Candidats disponibles</div>`;
  const alreadyHiredIds = new Set(G.detectives.map(d=>d.id));

  HIRE_CANDIDATES.filter(c=>!alreadyHiredIds.has(c.id)).forEach(c => {
    html += `<div class="hire-option" onclick="hireDetective(${c.id})">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;">
        <span class="t-heading" style="font-size:1rem;">${c.nom}</span>
        <span class="t-mono" style="color:var(--accent);">${c.cout}€</span>
      </div>
      <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:8px;">${c.bio}</div>
      ${renderStatPips(c)}
      <div class="det-traits" style="margin-top:8px;">${c.traits.map(t=>`<span class="trait">${t}</span>`).join('')}</div>
      <div class="salary-label t-label" style="margin-top:8px;">${c.salaire}€/jour</div>
    </div>`;
  });

  if (HIRE_CANDIDATES.filter(c=>!alreadyHiredIds.has(c.id)).length === 0) {
    html += `<p style="color:var(--text-muted);font-size:0.85rem;">Aucun candidat disponible pour le moment.</p>`;
  }

  html += `<div style="margin-top:20px;"><button class="btn small" onclick="closeModal()">Fermer</button></div>`;
  content.innerHTML = html;
  document.getElementById('overlay').classList.add('active');
}

function hireDetective(id) {
  const candidate = HIRE_CANDIDATES.find(c=>c.id===id);
  if (!candidate) return;
  if (G.money < candidate.cout) {
    addLog(`Fonds insuffisants pour recruter ${candidate.nom}.`, 'failure');
    closeModal();
    return;
  }
  G.money -= candidate.cout;
  G.detectives.push({...candidate, indisponible:0});
  addLog(`${candidate.nom} rejoint l'agence. -${candidate.cout}€`, 'success');
  closeModal();
  updateUI();
}

function openRulesModal() {
  const content = document.getElementById('modal-content');
  content.innerHTML = `
    <div class="modal-title t-title">Règles du jeu</div>
    <div class="modal-label">Détectives Inc. — Guide de l'agence</div>

    <div class="modal-result" style="margin-bottom:12px;">
      <div class="result-label" style="color:var(--accent);margin-bottom:8px;">Objectif</div>
      <div class="result-text" style="font-style:normal;color:var(--text-secondary);line-height:1.8;">
        Diriger l'agence Détectives Inc. le plus longtemps possible. Résolvez des affaires, gérez vos enquêteurs et maintenez votre réputation. Le jeu se termine si vos fonds tombent à zéro sans enquêteur disponible, ou si votre réputation atteint 0.
      </div>
    </div>

    <div class="modal-result" style="margin-bottom:12px;">
      <div class="result-label" style="color:var(--accent);margin-bottom:8px;">La journée en 4 phases</div>
      <div class="result-text" style="font-style:normal;color:var(--text-secondary);line-height:1.9;">
        <strong style="color:var(--text-primary);">1. Aube</strong> — 3 affaires aléatoires arrivent, accompagnées d'un événement du jour et de 2 cartes bonus.<br><br>
        <strong style="color:var(--text-primary);">2. Assignation</strong> — Cliquez sur une affaire, puis sur un enquêteur disponible, puis (optionnel) sur une carte bonus. Cliquez "Assigner" pour valider. Répétez pour chaque affaire.<br><br>
        <strong style="color:var(--text-primary);">3. Résolution</strong> — Le jeu calcule les résultats. Chaque affaire réussie rapporte de l'argent et de la réputation. Un échec coûte 50€ et -8 réputation.<br><br>
        <strong style="color:var(--text-primary);">4. Soir</strong> — Salaires et loyer prélevés automatiquement. Bilan de la journée.
      </div>
    </div>

    <div class="modal-result" style="margin-bottom:12px;">
      <div class="result-label" style="color:var(--accent);margin-bottom:8px;">Calcul du succès</div>
      <div class="result-text" style="font-style:normal;color:var(--text-secondary);line-height:1.8;">
        Chaque crime a un type dominant : <span style="color:#c8b896;">Action</span>, <span style="color:#7a9ab5;">Réflexion</span> ou <span style="color:#8b3a3a;">Danger</span>. La compétence de l'enquêteur dans ce domaine est comparée à la difficulté du crime. Les cartes bonus, événements et niveau de réputation modifient le pourcentage final. Le succès n'est jamais garanti — ni impossible.
      </div>
    </div>

    <div class="modal-result" style="margin-bottom:12px;">
      <div class="result-label" style="color:var(--accent);margin-bottom:8px;">Enquêteurs</div>
      <div class="result-text" style="font-style:normal;color:var(--text-secondary);line-height:1.8;">
        Un enquêteur <span style="color:var(--danger);">corrompu</span> prélève 20% des gains à votre insu. Un enquêteur <span style="color:var(--warn-bright);">malade</span> perd 1 point d'Action. Un enquêteur blessé sur une affaire dangereuse est <span style="color:var(--danger);">indisponible</span> 2 jours. Tous vieillissent tous les 5 jours — leur profil évolue avec l'âge.
      </div>
    </div>

    <div class="modal-result" style="margin-bottom:12px;">
      <div class="result-label" style="color:var(--accent);margin-bottom:8px;">Réputation & Finances</div>
      <div class="result-text" style="font-style:normal;color:var(--text-secondary);line-height:1.8;">
        La réputation influence les chances de succès (+5% au-dessus de 70, -5% en dessous de 30). Les salaires et le loyer (100€/jour) sont prélevés chaque soir. Recrutez de nouveaux enquêteurs via le bouton <strong style="color:var(--text-primary);">+ Recruter</strong> — une dépense d'investissement.
      </div>
    </div>

    <div class="modal-result" style="margin-bottom:20px;">
      <div class="result-label" style="color:var(--accent);margin-bottom:8px;">Cartes bonus</div>
      <div class="result-text" style="font-style:normal;color:var(--text-secondary);line-height:1.8;">
        Chaque jour, 2 cartes bonus sont disponibles. Elles peuvent être assignées à une affaire lors de la phase d'assignation. Certaines ont des effets cachés négatifs — lisez-les attentivement. Une carte ne peut être utilisée que sur une seule affaire par jour.
      </div>
    </div>

    <button class="btn small" onclick="closeModal()">Fermer</button>
  `;
  document.getElementById('overlay').classList.add('active');
}


  document.getElementById('overlay').classList.remove('active');
}

/* ══════════════════════════════════════════════
   UI
══════════════════════════════════════════════ */
function updateUI() {
  document.getElementById('ui-money').textContent = `${G.money}€`;
  document.getElementById('ui-money').className = `stat-val ${G.money>300?'good':G.money>100?'warn':'danger'}`;
  document.getElementById('ui-rep').textContent = G.reputation;
  document.getElementById('ui-rep').className = `stat-val ${G.reputation>60?'good':G.reputation>30?'':' danger'}`;
  document.getElementById('ui-rep-bar').style.width = G.reputation+'%';
  const avail = G.detectives.filter(d=>d.indisponible===0).length;
  document.getElementById('ui-dets').textContent = `${avail}/${G.detectives.length}`;
  document.getElementById('ui-day').textContent = `Jour ${G.day}`;
}

function addLog(msg, type='system') {
  const log = document.getElementById('log');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  entry.textContent = msg;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
  // Keep max 30 entries
  while(log.children.length > 30) log.removeChild(log.firstChild);
}

function gameOver(reason) {
  const go = document.getElementById('gameover');
  document.getElementById('go-reason').textContent = reason;
  document.getElementById('go-stats').innerHTML = `
    <div class="result-row"><span class="t-label">Jours tenus</span><span class="t-mono">${G.totalDays}</span></div>
    <div class="result-row"><span class="t-label">Affaires résolues</span><span class="t-mono">${G.totalResolved}</span></div>
    <div class="result-row"><span class="t-label">Réputation finale</span><span class="t-mono">${G.reputation}/100</span></div>
    <div class="result-row"><span class="t-label">Fonds restants</span><span class="t-mono">${G.money}€</span></div>
  `;
  go.classList.add('active');
}

function handleAction() {
  // delegated to onclick of btn-action
}

/* Close overlay on background click */
document.getElementById('overlay').addEventListener('click', function(e){
  if(e.target === this) closeModal();
});

/* ══════════════════════════════════════════════
   INIT
══════════════════════════════════════════════ */
initGame();
</script>
</body>
</html>
